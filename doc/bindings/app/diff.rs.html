<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Module List</title>
    <link rel="stylesheet" type="text/css" href="../../../css/lua.css">
</head>
<body>
	<pre><code id="1">use rlua::prelude::*;</code><code id="2">use std::{fs, io};</code><code id="3">use std::io::BufRead;</code><code id="4">use chrono::{DateTime, Local};</code><code id="5">use diff_rs::diff;</code><code id="6"></code><code id="7">fn time_format(d: &amp;DateTime&lt;Local&gt;) -&gt; String {</code><code id="8">    d.format(&quot;%Y-%m-%d %H:%M:%S.%f %z&quot;).to_string()</code><code id="9">}</code><code id="10"></code><code id="11">fn mtime(path: &amp;str) -&gt; ::Result&lt;DateTime&lt;Local&gt;&gt; {</code><code id="12">    Ok(DateTime::from(fs::metadata(path)?.modified()?))</code><code id="13">}</code><code id="14"></code><code id="15">fn read_file(path: &amp;str) -&gt; io::Result&lt;Vec&lt;String&gt;&gt; {</code><code id="16">    let file = fs::File::open(path)?;</code><code id="17">    let file = io::BufReader::new(file);</code><code id="18">    file.lines().collect()</code><code id="19">}</code><code id="20"></code><code id="21">pub fn init(lua: &amp;Lua) -&gt; ::Result&lt;()&gt; {</code><code id="22">    let module = lua.create_table()?;</code><code id="23"></code><code id="24">    module.set(&quot;compare_strings&quot;, lua.create_function( |_, (left, right): (String, String)| {</code><code id="25">        let prefix = vec![</code><code id="26">            format!(&quot;--- a\t{}&quot;, time_format(&amp;Local::now())),</code><code id="27">            format!(&quot;+++ b\t{}&quot;, time_format(&amp;Local::now()))</code><code id="28">        ];</code><code id="29"></code><code id="30">        let diff = diff(</code><code id="31">            &amp;left</code><code id="32">                .split(&quot;\n&quot;)</code><code id="33">                .map(str::to_owned)</code><code id="34">                .collect::&lt;Vec&lt;_&gt;&gt;(),</code><code id="35">            &amp;right</code><code id="36">                .split(&quot;\n&quot;)</code><code id="37">                .map(str::to_owned)</code><code id="38">                .collect::&lt;Vec&lt;_&gt;&gt;(),</code><code id="39">                3</code><code id="40">            ).map_err(LuaError::external)?;</code><code id="41">        </code><code id="42">        let mut res = String::new();</code><code id="43">        prefix.iter().cloned().chain(diff).for_each(|s| { res.push_str(&amp;s); res.push(&#x27;\n&#x27;) });</code><code id="44"></code><code id="45">        Ok(res)</code><code id="46">    })?)?;</code><code id="47"></code><code id="48">    module.set(&quot;compare_files&quot;, lua.create_function( |_, (left, right): (String, String)| {</code><code id="49">        let prefix = vec![</code><code id="50">            format!(&quot;--- {}\t{}&quot;, &amp;left, time_format(&amp;mtime(&amp;left).map_err(LuaError::external)?)),</code><code id="51">            format!(&quot;+++ {}\t{}&quot;, &amp;right, time_format(&amp;mtime(&amp;right).map_err(LuaError::external)?))</code><code id="52">        ];</code><code id="53"></code><code id="54">        let left = read_file(&amp;left).map_err(LuaError::external)?;</code><code id="55">        let right = read_file(&amp;right).map_err(LuaError::external)?;</code><code id="56"></code><code id="57">        let diff = diff(&amp;left, &amp;right, 3).map_err(LuaError::external)?;</code><code id="58"></code><code id="59">        let mut res = String::new();</code><code id="60">        prefix.iter().cloned().chain(diff).for_each(|s| { res.push_str(&amp;s); res.push(&#x27;\n&#x27;) });</code><code id="61"></code><code id="62">        Ok(res)</code><code id="63">    })?)?;</code><code id="64"></code><code id="65"></code><code id="66">    lua.globals().set(&quot;diff&quot;, module)?;</code><code id="67"></code><code id="68">    Ok(())</code><code id="69">}</code><code id="70"></code><code id="71"></code></pre>
</body>
</html>
