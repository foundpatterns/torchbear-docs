<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Module List</title>
    <link rel="stylesheet" type="text/css" href="../../../css/lua.css">
</head>
<body>
	<pre><code id="1">use rlua::prelude::*;</code><code id="2">use std::sync::Arc;</code><code id="3">use std::fs;</code><code id="4">use serde_json;</code><code id="5">use rlua_serde;</code><code id="6"></code><code id="7">pub fn init(lua: &amp;Lua) -&gt; ::Result&lt;()&gt; {</code><code id="8"></code><code id="9">    let module = lua.create_table()?;</code><code id="10"></code><code id="11">    module.set(&quot;canonicalize&quot;, lua.create_function( |lua, path: String| {</code><code id="12">        match fs::canonicalize(path).map_err(|err| LuaError::external(err)) {</code><code id="13">            Ok(i) =&gt; Ok(Some(lua.create_string(&amp;i.to_str().unwrap()).unwrap())),</code><code id="14">            _ =&gt; Ok(None)</code><code id="15">        }</code><code id="16">    })? )?;</code><code id="17"></code><code id="18">    module.set(&quot;create_dir&quot;, lua.create_function( |_, (path, all): (String, Option&lt;bool&gt;)| {</code><code id="19">        let result = match all {</code><code id="20">            Some(true) =&gt; fs::create_dir_all(path),</code><code id="21">            _ =&gt; fs::create_dir(path)</code><code id="22">        };</code><code id="23">        Ok(result.is_ok())</code><code id="24">    })? )?;</code><code id="25"></code><code id="26">    &#x2F;&#x2F;TODO: &#x27;fs.entries&#x27; works sometimes, while at random it fails to work and returns</code><code id="27">    &#x2F;&#x2F;      a nil value in test as well as in actual use</code><code id="28">    &#x2F;&#x2F;      Sort out and correct the issues in relations to this problem</code><code id="29">    &#x2F;&#x2F;      Possibly related to https:&#x2F;&#x2F;github.com&#x2F;foundpatterns&#x2F;torchbear&#x2F;issues&#x2F;84</code><code id="30">    module.set(&quot;entries&quot;, lua.create_function( |lua, path: String| {</code><code id="31">        match fs::read_dir(path) {</code><code id="32">            Ok(iter) =&gt; {</code><code id="33">                let mut arc_iter = Arc::new(Some(iter));</code><code id="34">                let mut f = move |_, _: ()| {</code><code id="35">                    let result = match Arc::get_mut(&amp;mut arc_iter).expect(&quot;entries iterator is mutably borrowed&quot;) {</code><code id="36">                        Some(iter) =&gt; match iter.next() {</code><code id="37">                            Some(Ok(entry)) =&gt; Some(entry.file_name().into_string().unwrap()),</code><code id="38">                            _ =&gt; None</code><code id="39">                        },</code><code id="40">                        None =&gt; None</code><code id="41">                    };</code><code id="42">                    if result.is_none() { *Arc::get_mut(&amp;mut arc_iter).unwrap() = None; }</code><code id="43">                    Ok(result)</code><code id="44">                };</code><code id="45">                Ok(lua.create_function_mut(f)?)</code><code id="46">            }, Err(err) =&gt; Err(LuaError::ExternalError(Arc::new(::failure::Error::from_boxed_compat(Box::new(err)))))</code><code id="47">        }</code><code id="48">    })? )?;</code><code id="49"></code><code id="50">    module.set(&quot;read_dir&quot;, lua.create_function( |lua, path: String| {</code><code id="51">        let mut _list: Vec&lt;String&gt; = Vec::new();</code><code id="52">        for entry in fs::read_dir(path).map_err(|err| LuaError::external(err))? {</code><code id="53">            let entry = entry.map_err(|err| LuaError::external(err))?;</code><code id="54">            _list.push(entry.path().file_name().unwrap_or_default().to_string_lossy().to_string());      </code><code id="55">        }</code><code id="56">        let list_value: serde_json::Value = serde_json::to_value(_list).map_err(|err| LuaError::external(err) )?;</code><code id="57">        let lua_value = rlua_serde::to_value(lua, &amp;list_value)?;</code><code id="58">        Ok(lua_value)</code><code id="59">    })?)?;</code><code id="60"></code><code id="61">    module.set(&quot;read_file&quot;, lua.create_function( |lua, path: String| {</code><code id="62">        let data = fs::read(path).map_err(|err| LuaError::external(err))?;</code><code id="63">        Ok(lua.create_string(&amp;String::from_utf8_lossy(&amp;data[..]).to_owned().to_string())?)</code><code id="64">    })?)?;</code><code id="65"></code><code id="66">    module.set(&quot;exists&quot;, lua.create_function( |_, path: String| {</code><code id="67">        Ok(::std::path::Path::new(&amp;path).exists())</code><code id="68">    })?)?;</code><code id="69"></code><code id="70">    module.set(&quot;is_file&quot;, lua.create_function( |_, path: String| {</code><code id="71">        Ok(::std::path::Path::new(&amp;path).is_file())</code><code id="72">    })?)?;</code><code id="73"></code><code id="74">    module.set(&quot;is_dir&quot;, lua.create_function( |_, path: String| {</code><code id="75">        Ok(::std::path::Path::new(&amp;path).is_dir())</code><code id="76">    })?)?;</code><code id="77"></code><code id="78">    module.set(&quot;metadata&quot;, lua.create_function( |lua, path: String| {</code><code id="79">        match fs::metadata(path) {</code><code id="80">            Ok(md) =&gt; {</code><code id="81">                let table = lua.create_table()?;</code><code id="82"></code><code id="83">                table.set(&quot;type&quot;, {</code><code id="84">                    let file_type = md.file_type();</code><code id="85">                    if file_type.is_file() { &quot;file&quot; }</code><code id="86">                    else if file_type.is_dir() { &quot;directory&quot; }</code><code id="87">                    else { unreachable!() }</code><code id="88">                })?;</code><code id="89"></code><code id="90">                table.set(&quot;size&quot;, md.len())?;</code><code id="91"></code><code id="92">                &#x2F;&#x2F; TODO: Unix permissions when in Unix</code><code id="93">                table.set(&quot;readonly&quot;, md.permissions().readonly())?;</code><code id="94"></code><code id="95">                &#x2F;&#x2F; TODO: modified, created and accesed timestamps</code><code id="96">                </code><code id="97">                Ok(Some(table))</code><code id="98">            },</code><code id="99">            _ =&gt; Ok(None)</code><code id="100">        }</code><code id="101">    })? )?;</code><code id="102"></code><code id="103">    lua.globals().set(&quot;fs&quot;, module)?;</code><code id="104"></code><code id="105">    Ok(())</code><code id="106">}</code><code id="107"></code><code id="108">#[cfg(test)]</code><code id="109">mod tests {</code><code id="110">    use super::*;</code><code id="111"></code><code id="112">    #[test]</code><code id="113">    fn lua_fs () {</code><code id="114">        let lua = Lua::new();</code><code id="115">        init(&amp;lua).unwrap();</code><code id="116"></code><code id="117">        lua.exec::&lt;_, ()&gt;(r#&quot;</code><code id="118">            for entry in fs.entries(&quot;.&#x2F;&quot;) do</code><code id="119">                local md = fs.metadata(entry)</code><code id="120">                print(md.type .. &quot;: &quot; .. entry)</code><code id="121">            end</code><code id="122"></code><code id="123">            assert(fs.canonicalize(&quot;.&quot;), &quot;expected path&quot;)</code><code id="124">            assert(fs.canonicalize(&quot;&#x2F;no&#x2F;such&#x2F;path&#x2F;here&quot;) == nil, &quot;expected nil&quot;)</code><code id="125">        &quot;#, None).unwrap();</code><code id="126">    }</code><code id="127">}</code></pre>
</body>
</html>
