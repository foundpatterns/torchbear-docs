<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Module List</title>
    <link rel="stylesheet" type="text/css" href="../../../css/lua.css">
</head>
<body>
	<pre><code id="1">use rlua::prelude::*;</code><code id="2">use rlua::{UserDataMethods, UserData, MetaMethod, Lua};</code><code id="3">use chrono::prelude::*;</code><code id="4"></code><code id="5">#[derive(Clone)]</code><code id="6">struct LuaTime (DateTime&lt;Utc&gt;);</code><code id="7"></code><code id="8">impl UserData for LuaTime {</code><code id="9">    fn add_methods&lt;&#x27;lua, M: UserDataMethods&lt;&#x27;lua, Self&gt;&gt;(methods: &amp;mut M) {</code><code id="10">        methods.add_meta_method(MetaMethod::ToString, |_, this, _: ()| {</code><code id="11">            Ok(this.0.to_rfc2822())</code><code id="12">        });</code><code id="13"></code><code id="14">        methods.add_meta_method(MetaMethod::Eq, |_, this, that: LuaTime| {</code><code id="15">            Ok(this.0 == that.0)</code><code id="16">        });</code><code id="17"></code><code id="18">        methods.add_meta_method(MetaMethod::Lt, |_, this, that: LuaTime| {</code><code id="19">            Ok(this.0 &lt; that.0)</code><code id="20">        });</code><code id="21"></code><code id="22">        methods.add_meta_method(MetaMethod::Le, |_, this, that: LuaTime| {</code><code id="23">            Ok(this.0 &lt;= that.0)</code><code id="24">        });</code><code id="25">    }</code><code id="26">}</code><code id="27"></code><code id="28">pub fn init(lua: &amp;Lua) -&gt; ::Result&lt;()&gt; {</code><code id="29">    let module = lua.create_table()?;</code><code id="30"></code><code id="31">    module.set(&quot;now&quot;, lua.create_function( |_, _: ()| {</code><code id="32">        Ok(LuaTime(Utc::now()))</code><code id="33">    })? )?;</code><code id="34"></code><code id="35">    module.set(&quot;new&quot;, lua.create_function( |_, s: String| {</code><code id="36">        DateTime::parse_from_rfc2822(&amp;s).map(</code><code id="37">            |t| LuaTime(t.with_timezone(&amp;Utc))</code><code id="38">        ).map_err(</code><code id="39">            |_| LuaError::RuntimeError(&quot;Invalid time string&quot;.to_string())</code><code id="40">        )</code><code id="41">    })? )?;</code><code id="42"></code><code id="43">    lua.globals().set(&quot;time&quot;, module)?;</code><code id="44"></code><code id="45">    Ok(())</code><code id="46">}</code><code id="47"></code><code id="48">#[cfg(test)]</code><code id="49">mod tests {</code><code id="50">    use super::*;</code><code id="51"></code><code id="52">    #[test]</code><code id="53">    fn lua_time () {</code><code id="54">        let lua = Lua::new();</code><code id="55">        init(&amp;lua).unwrap();</code><code id="56"></code><code id="57">        lua.exec::&lt;_, ()&gt;(r#&quot;</code><code id="58">            print(time.now())</code><code id="59">            print(time.new(&quot;Fri, 28 Nov 2014 12:00:09 +0000&quot;))</code><code id="60">        &quot;#, None).unwrap();</code><code id="61"></code><code id="62">        assert!(lua.exec::&lt;_, ()&gt;(&quot;print(time.new(&#x27;lol&#x27;))&quot;, None).is_err());</code><code id="63">    }</code><code id="64">}</code></pre>
</body>
</html>
