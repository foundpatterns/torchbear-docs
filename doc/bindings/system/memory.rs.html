<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Module List</title>
    <link rel="stylesheet" type="text/css" href="../../../css/lua.css">
</head>
<body>
	<pre><code id="1">use rlua::prelude::*;</code><code id="2">use std::{</code><code id="3">    mem,</code><code id="4">    io::{Cursor, SeekFrom, prelude::*}</code><code id="5">};</code><code id="6">use serde_json;</code><code id="7">use rlua_serde;</code><code id="8"></code><code id="9">&#x2F;&#x2F;TODO: Move to having a common interface so IO can share the same binding</code><code id="10">pub struct LuaMemory(Cursor&lt;Vec&lt;u8&gt;&gt;);</code><code id="11"></code><code id="12">impl LuaUserData for LuaMemory {</code><code id="13">    fn add_methods&lt;&#x27;lua, M: LuaUserDataMethods&lt;&#x27;lua, Self&gt;&gt;(methods: &amp;mut M) {</code><code id="14">        methods.add_method_mut(&quot;read&quot;, |_, this: &amp;mut LuaMemory, len: Option&lt;usize&gt;|{</code><code id="15">            let bytes = match len {</code><code id="16">                Some(len) =&gt; {</code><code id="17">                    let mut bytes = vec![0u8; len];</code><code id="18">                    this.0.read(&amp;mut bytes).map_err(LuaError::external)?;</code><code id="19">                    bytes</code><code id="20">                },</code><code id="21">                None =&gt; {</code><code id="22">                    let mut bytes = vec![];</code><code id="23">                    this.0.read_to_end(&amp;mut bytes).map_err(LuaError::external)?;</code><code id="24">                    bytes</code><code id="25">                }</code><code id="26">            };</code><code id="27">            Ok(bytes)</code><code id="28">        });</code><code id="29">        methods.add_method_mut(&quot;read_to_string&quot;, |_, this: &amp;mut LuaMemory, _: ()|{</code><code id="30">            let mut data = String::new();</code><code id="31">            this.0.read_to_string(&amp;mut data).map_err(LuaError::external)?;</code><code id="32">            Ok(data)</code><code id="33">        });</code><code id="34">        methods.add_method_mut(&quot;write&quot;, |_, this: &amp;mut LuaMemory, bytes: Vec&lt;u8&gt;|{</code><code id="35">            Ok(this.0.write(bytes.as_slice()).map_err(LuaError::external)?)</code><code id="36">        });</code><code id="37">        methods.add_method_mut(&quot;write&quot;, |_, this: &amp;mut LuaMemory, str: String|{</code><code id="38">            Ok(this.0.write(str.as_bytes()).map_err(LuaError::external)?)</code><code id="39">        });</code><code id="40">        methods.add_method_mut(&quot;flush&quot;, |_, this: &amp;mut LuaMemory, _: ()|{</code><code id="41">            Ok(this.0.flush().map_err(LuaError::external)?)</code><code id="42">        });</code><code id="43">        methods.add_method_mut(&quot;clear&quot;, |_, this: &amp;mut LuaMemory, _: ()|{</code><code id="44">            mem::replace(&amp;mut this.0, Cursor::new(Vec::new()));</code><code id="45">            Ok(())</code><code id="46">        });</code><code id="47">        methods.add_method_mut(&quot;seek&quot;, |_, this: &amp;mut LuaMemory, (pos, size): (Option&lt;String&gt;, Option&lt;usize&gt;)| {</code><code id="48">            let size = size.unwrap_or(0);</code><code id="49"></code><code id="50">            let seekfrom = pos.and_then(|s_pos| {</code><code id="51">                Some(match s_pos.as_ref() {</code><code id="52">                    &quot;start&quot; =&gt; SeekFrom::Start(size as u64),</code><code id="53">                    &quot;end&quot; =&gt; SeekFrom::End(size as i64),</code><code id="54">                    &quot;current&quot; | _ =&gt; SeekFrom::Current(size as i64),</code><code id="55">                })</code><code id="56">            }).unwrap_or(SeekFrom::Current(size as i64));</code><code id="57">            Ok(this.0.seek(seekfrom).map_err(LuaError::external)?)</code><code id="58">        });</code><code id="59">        methods.add_method_mut(&quot;dump&quot;, |_, this: &amp;mut LuaMemory, _: ()|{</code><code id="60">            Ok(this.0.clone().into_inner())</code><code id="61">        });</code><code id="62">    }</code><code id="63">}</code><code id="64"></code><code id="65">pub fn init(lua: &amp;Lua) -&gt; crate::Result&lt;()&gt; {</code><code id="66"></code><code id="67">    let module = lua.create_table()?;</code><code id="68"></code><code id="69">    module.set(&quot;new&quot;, lua.create_function( |_, _: ()| {</code><code id="70">        Ok(LuaMemory(Cursor::new(Vec::new())))</code><code id="71">    })?  )?;</code><code id="72"></code><code id="73">    lua.globals().set(&quot;memory&quot;, module)?;</code><code id="74"></code><code id="75">    Ok(())</code><code id="76">}</code></pre>
</body>
</html>
