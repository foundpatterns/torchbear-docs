<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Module List</title>
    <link rel="stylesheet" type="text/css" href="../../../css/lua.css">
</head>
<body>
	<pre><code id="1">use rlua::prelude::*;</code><code id="2">use crate::bindings::system::LuaMetadata;</code><code id="3">use std::{fs, path};</code><code id="4">use std::sync::Arc;</code><code id="5"></code><code id="6">pub struct LuaPath(pub path::PathBuf);</code><code id="7"></code><code id="8">impl LuaUserData for LuaPath {</code><code id="9">    fn add_methods&lt;&#x27;lua, M: LuaUserDataMethods&lt;&#x27;lua, Self&gt;&gt;(methods: &amp;mut M) {</code><code id="10">        methods.add_method(&quot;file_stem&quot;, |_, this: &amp;LuaPath, _:() |{</code><code id="11">            Ok(this.0.file_stem().map(|p| p.to_str().map(|s| s.to_string())))</code><code id="12">        });</code><code id="13">        methods.add_method(&quot;file_name&quot;, |_, this: &amp;LuaPath, _:() |{</code><code id="14">            Ok(this.0.file_name().map(|p| p.to_str().map(|s| s.to_string())))</code><code id="15">        });</code><code id="16">        methods.add_method(&quot;ext&quot;, |_, this: &amp;LuaPath, _:() |{</code><code id="17">            Ok(this.0.extension().map(|p| p.to_str().map(|s| s.to_string())))</code><code id="18">        });</code><code id="19">        methods.add_method(&quot;exists&quot;, |_, this: &amp;LuaPath, _:() |{</code><code id="20">            Ok(this.0.exists())</code><code id="21">        });</code><code id="22">        methods.add_method(&quot;is_dir&quot;, |_, this: &amp;LuaPath, _:() |{</code><code id="23">            Ok(this.0.is_dir())</code><code id="24">        });</code><code id="25">        methods.add_method(&quot;is_file&quot;, |_, this: &amp;LuaPath, _:() |{</code><code id="26">            Ok(this.0.is_file())</code><code id="27">        });</code><code id="28">        methods.add_method(&quot;create_file&quot;, |_, this: &amp;LuaPath, _: ()| {</code><code id="29">            fs::OpenOptions::new()</code><code id="30">                .write(true)</code><code id="31">                .create(true)</code><code id="32">                .open(this.0.as_path())</code><code id="33">                .map(|_| ())</code><code id="34">                .map_err(LuaError::external)</code><code id="35">        });</code><code id="36">        methods.add_method(&quot;create_dir&quot;, |_, this: &amp;LuaPath, opt: Option&lt;bool&gt;| {</code><code id="37">            match opt {</code><code id="38">                Some(true) =&gt; fs::create_dir_all(this.0.as_path()).map_err(LuaError::external),</code><code id="39">                _ =&gt; fs::create_dir(this.0.as_path()).map_err(LuaError::external)</code><code id="40">            }</code><code id="41">        });</code><code id="42">        methods.add_method(&quot;remove&quot;, |_, this: &amp;LuaPath, opt: Option&lt;bool&gt;| {</code><code id="43">            if this.0.exists() {</code><code id="44">                if this.0.is_file() {</code><code id="45">                    return fs::remove_file(&amp;this.0).map_err(LuaError::external);</code><code id="46">                } else if this.0.is_dir() {</code><code id="47">                    return match opt {</code><code id="48">                        Some(true) =&gt; fs::remove_dir_all(&amp;this.0).map_err(LuaError::external),</code><code id="49">                        _ =&gt; fs::remove_dir(&amp;this.0).map_err(LuaError::external)</code><code id="50">                    };</code><code id="51">                }</code><code id="52">            }</code><code id="53">            Ok(())</code><code id="54">        });</code><code id="55">        methods.add_method(&quot;is_relative&quot;, |_, this: &amp;LuaPath, _:() |{</code><code id="56">            Ok(this.0.is_relative())</code><code id="57">        });</code><code id="58">        methods.add_method(&quot;is_absolute&quot;, |_, this: &amp;LuaPath, _:() |{</code><code id="59">            Ok(this.0.is_absolute())</code><code id="60">        });</code><code id="61">        methods.add_method(&quot;has_root&quot;, |_, this: &amp;LuaPath, _:() |{</code><code id="62">            Ok(this.0.has_root())</code><code id="63">        });</code><code id="64">        methods.add_method(&quot;parent&quot;, |_, this: &amp;LuaPath, _:() |{</code><code id="65">            Ok(this.0.parent().map(|p| LuaPath(p.to_path_buf())))</code><code id="66">        });</code><code id="67">        methods.add_method_mut(&quot;push&quot;, |_, this: &amp;mut LuaPath, val: String |{</code><code id="68">            Ok(this.0.push(&amp;val))</code><code id="69">        });</code><code id="70">        methods.add_method(&quot;join&quot;, |_, this: &amp;LuaPath, path: String |{</code><code id="71">            Ok(LuaPath(this.0.join(path)))</code><code id="72">        });</code><code id="73">        methods.add_method(&quot;metadata&quot;, |_, this: &amp;LuaPath, _:() |{</code><code id="74">            Ok(LuaMetadata(this.0.metadata().map_err(LuaError::external)?))</code><code id="75">        });</code><code id="76">        methods.add_method(&quot;canonicalize&quot;, |_, this: &amp;LuaPath, _:() |{</code><code id="77">            fs::canonicalize(&amp;this.0).map(|can| can.to_str().map(|s| s.to_string())).map_err(LuaError::external)</code><code id="78">        });</code><code id="79">        methods.add_method(&quot;read_dir&quot;, |lua, this: &amp;LuaPath, _: ()| {</code><code id="80">            match this.0.read_dir() {</code><code id="81">                Ok(iter) =&gt; {</code><code id="82">                    let mut arc_iter = Arc::new(Some(iter));</code><code id="83">                    let f = move |_, _: ()| {</code><code id="84">                        let result = match Arc::get_mut(&amp;mut arc_iter).expect(&quot;entries iterator is mutably borrowed&quot;) {</code><code id="85">                            Some(iter) =&gt; iter.next().map(|entry| entry.map(|e| LuaPath(e.path())).ok()),</code><code id="86">                            None =&gt; None</code><code id="87">                        };</code><code id="88">                        if result.is_none() { *Arc::get_mut(&amp;mut arc_iter).unwrap() = None; }</code><code id="89">                        Ok(result)</code><code id="90">                    };</code><code id="91">                    Ok(lua.create_function_mut(f)?)</code><code id="92">                }, Err(err) =&gt; Err(LuaError::external(err))</code><code id="93">            }</code><code id="94">        });</code><code id="95">        methods.add_meta_method(LuaMetaMethod::ToString, |_, this: &amp;LuaPath, _: ()| {</code><code id="96">            Ok(this.0.to_str().map(|s| s.to_string()))</code><code id="97">        });</code><code id="98">    }</code><code id="99">}</code><code id="100"></code><code id="101">pub fn init(lua: &amp;Lua) -&gt; crate::Result&lt;()&gt; {</code><code id="102">    let module = lua.create_table()?;</code><code id="103"></code><code id="104">    module.set(&quot;empty&quot;, lua.create_function( |_, _: ()| {</code><code id="105">        Ok(LuaPath(path::PathBuf::new()))</code><code id="106">    })? )?;</code><code id="107"></code><code id="108">    module.set(&quot;new&quot;, lua.create_function( |_, path: String| {</code><code id="109">        Ok(LuaPath(path::Path::new(&amp;path).to_path_buf()))</code><code id="110">    })? )?;</code><code id="111"></code><code id="112">    lua.globals().set(&quot;path&quot;, module)?;</code><code id="113"></code><code id="114">    Ok(())</code><code id="115">}</code><code id="116"></code></pre>
</body>
</html>
