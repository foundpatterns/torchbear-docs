<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Module List</title>
    <link rel="stylesheet" type="text/css" href="../../../css/lua.css">
</head>
<body>
	<pre><code id="1">use rlua::prelude::*;</code><code id="2">use regex;</code><code id="3"></code><code id="4">pub fn init(lua: &amp;Lua) -&gt; ::Result&lt;()&gt; {</code><code id="5">    let module = lua.create_table()?;</code><code id="6"></code><code id="7">    module.set(&quot;match&quot;, lua.create_function(|_, (expr, val): (String, String)| {</code><code id="8">        let re = regex::Regex::new(&amp;expr).map_err(LuaError::external)?;</code><code id="9">        Ok(re.is_match(&amp;val))</code><code id="10">    })?)?;</code><code id="11"></code><code id="12">    module.set(&quot;replace_all&quot;, lua.create_function(|_, (expr, val, patt): (String, String, String)| {</code><code id="13">        let re = regex::Regex::new(&amp;expr).map_err(LuaError::external)?;</code><code id="14">        Ok(re.replace_all(&amp;val, patt.as_str()).into_owned())</code><code id="15">    })?)?;</code><code id="16"></code><code id="17">    module.set(&quot;captures&quot;, lua.create_function(|_, (expr, val): (String, String)| {</code><code id="18">        let re = regex::Regex::new(&amp;expr).map_err(LuaError::external)?;</code><code id="19"></code><code id="20">        Ok(re.captures(&amp;val).and_then(|v| {</code><code id="21">            Some(v.iter().filter_map(|s| s).map(|s| s.as_str().to_string()).collect::&lt;Vec&lt;String&gt;&gt;())</code><code id="22">        }))</code><code id="23"></code><code id="24">    })?)?;</code><code id="25"></code><code id="26">    lua.globals().set(&quot;regex&quot;, module)?;</code><code id="27"></code><code id="28">    Ok(())</code><code id="29">}</code><code id="30"></code><code id="31">#[cfg(test)]</code><code id="32">mod tests {</code><code id="33">    use super::*;</code><code id="34"></code><code id="35">    #[test]</code><code id="36">    fn lua_regex_replace_all () {</code><code id="37">        let lua = Lua::new();</code><code id="38">        init(&amp;lua).unwrap();</code><code id="39"></code><code id="40">        lua.exec::&lt;_, ()&gt;(r#&quot;</code><code id="41">            local expr = [[(?P&lt;y&gt;\d{4})-(?P&lt;m&gt;\d{2})-(?P&lt;d&gt;\d{2})]]</code><code id="42">            local before = &quot;2012-03-14, 2013-01-01 and 2014-07-05&quot;</code><code id="43">            local result = regex.replace_all(expr, before, &quot;$m&#x2F;$d&#x2F;$y&quot;)</code><code id="44"></code><code id="45">            assert(result == &quot;03&#x2F;14&#x2F;2012, 01&#x2F;01&#x2F;2013 and 07&#x2F;05&#x2F;2014&quot;)</code><code id="46">        &quot;#, None).unwrap();</code><code id="47">    }</code><code id="48"></code><code id="49">    #[test]</code><code id="50">    fn lua_regex_match () {</code><code id="51">        let lua = Lua::new();</code><code id="52">        init(&amp;lua).unwrap();</code><code id="53"></code><code id="54">        lua.exec::&lt;_, ()&gt;(r#&quot;</code><code id="55">            local expr = [[^\d{4}-\d{2}-\d{2}$]]</code><code id="56">            local date = &quot;2014-01-01&quot;</code><code id="57">            local result = regex.match(expr, date)</code><code id="58"></code><code id="59">            assert(result == true)</code><code id="60">        &quot;#, None).unwrap();</code><code id="61">    }</code><code id="62"></code><code id="63">    #[test]</code><code id="64">    fn lua_regex_captures () {</code><code id="65">        let lua = Lua::new();</code><code id="66">        init(&amp;lua).unwrap();</code><code id="67"></code><code id="68">        lua.exec::&lt;_, ()&gt;(r#&quot;</code><code id="69">            local expr = [[&#x27;([^&#x27;]+)&#x27;\s+\((\d{4})\)]]</code><code id="70">            local val = &quot;Not my favorite movie: &#x27;Citizen Kane&#x27; (1941)&quot;</code><code id="71">            local result = regex.captures(expr, val)</code><code id="72"></code><code id="73">            assert(result ~= nil)</code><code id="74">            assert(result[1] == &quot;&#x27;Citizen Kane&#x27; (1941)&quot;)</code><code id="75">            assert(result[2] == &quot;Citizen Kane&quot;)</code><code id="76">            assert(result[3] == &quot;1941&quot;)</code><code id="77">        &quot;#, None).unwrap();</code><code id="78">    }</code><code id="79">}</code></pre>
</body>
</html>
