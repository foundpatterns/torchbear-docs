<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Module List</title>
    <link rel="stylesheet" type="text/css" href="../../../css/lua.css">
</head>
<body>
	<pre><code id="1">use rlua::prelude::*;</code><code id="2">use regex;</code><code id="3"></code><code id="4">pub struct LuaRegex(regex::Regex);</code><code id="5">pub struct LuaCapture&lt;&#x27;a&gt;(regex::Captures&lt;&#x27;a&gt;);</code><code id="6"></code><code id="7">impl LuaUserData for LuaRegex {</code><code id="8">    fn add_methods&lt;&#x27;lua, M: LuaUserDataMethods&lt;&#x27;lua, Self&gt;&gt;(methods: &amp;mut M) {</code><code id="9">        methods.add_method(&quot;match&quot;, |_, this: &amp;LuaRegex, val: String| {</code><code id="10">            Ok(this.0.is_match(&amp;val))</code><code id="11">        });</code><code id="12">        methods.add_method(&quot;replace_all&quot;, |_, this: &amp;LuaRegex, (val, patt): (String, String)| {</code><code id="13">            Ok(this.0.replace_all(&amp;val, patt.as_str()).into_owned())</code><code id="14">        });</code><code id="15">        methods.add_method(&quot;capture&quot;, |_, this: &amp;LuaRegex, val: String| {</code><code id="16">            Ok(this.0.captures(Box::leak(val.into_boxed_str())).map(LuaCapture))</code><code id="17">        });</code><code id="18">    } </code><code id="19">}</code><code id="20"></code><code id="21">impl&lt;&#x27;a&gt; LuaUserData for LuaCapture&lt;&#x27;a&gt; {</code><code id="22">    fn add_methods&lt;&#x27;lua, M: LuaUserDataMethods&lt;&#x27;lua, Self&gt;&gt;(methods: &amp;mut M) {</code><code id="23">        methods.add_method(&quot;get&quot;, |_, this: &amp;LuaCapture, index: usize| {</code><code id="24">            Ok(this.0.get(index).map(|s| s.as_str().to_string()))</code><code id="25">        });</code><code id="26">        methods.add_method(&quot;name&quot;, |_, this: &amp;LuaCapture, name: String| {</code><code id="27">            Ok(this.0.name(&amp;name).map(|s| s.as_str().to_string()))</code><code id="28">        });</code><code id="29">        methods.add_method(&quot;to_table&quot;, |_, this: &amp;LuaCapture, _: ()| {</code><code id="30">            Ok(this.0.iter().filter_map(|s| s).map(|s| s.as_str().to_string()).collect::&lt;Vec&lt;String&gt;&gt;())</code><code id="31">        })</code><code id="32">    }</code><code id="33">}</code><code id="34"></code><code id="35">pub fn init(lua: &amp;Lua) -&gt; crate::Result&lt;()&gt; {</code><code id="36">    let module = lua.create_table()?;</code><code id="37"></code><code id="38">    module.set(&quot;new&quot;, lua.create_function(|_, expr: String| {</code><code id="39">        regex::Regex::new(&amp;expr).map(LuaRegex).map_err(LuaError::external)</code><code id="40">    })?)?;</code><code id="41"></code><code id="42">    &#x2F;&#x2F;TODO: Move into method</code><code id="43">    &#x2F;&#x2F;TODO: Further investigation locally</code><code id="44">&#x2F;&#x2F;    module.set(&quot;capture_all&quot;, lua.create_function(|lua: &amp;Lua, (expr, val): (String, String) | {</code><code id="45">&#x2F;&#x2F;        let regex = regex::Regex::new(&amp;expr).map_err(LuaError::external)?;</code><code id="46">&#x2F;&#x2F;        let mut re = regex.captures_iter(Box::leak(val.into_boxed_str()));</code><code id="47">&#x2F;&#x2F;        let mut arc_iter = Arc::new(Some(re));</code><code id="48">&#x2F;&#x2F;        let mut f = move |_, _: ()| {</code><code id="49">&#x2F;&#x2F;            let result = match Arc::get_mut(&amp;mut arc_iter).expect(&quot;entries iterator is mutably borrowed&quot;) {</code><code id="50">&#x2F;&#x2F;                Some(iter) =&gt; iter.next().map(LuaCapture),</code><code id="51">&#x2F;&#x2F;                None =&gt; None</code><code id="52">&#x2F;&#x2F;            };</code><code id="53">&#x2F;&#x2F;            if result.is_none() { *Arc::get_mut(&amp;mut arc_iter).unwrap() = None; }</code><code id="54">&#x2F;&#x2F;            Ok(result)</code><code id="55">&#x2F;&#x2F;        };</code><code id="56">&#x2F;&#x2F;        Ok(lua.create_function_mut(f)?)</code><code id="57">&#x2F;&#x2F;    })?)?;</code><code id="58"></code><code id="59">    lua.globals().set(&quot;regex&quot;, module)?;</code><code id="60"></code><code id="61">    Ok(())</code><code id="62">}</code><code id="63"></code><code id="64">#[cfg(test)]</code><code id="65">mod tests {</code><code id="66">    use super::*;</code><code id="67"></code><code id="68">    #[test]</code><code id="69">    fn lua_regex_replace_all () {</code><code id="70">        let lua = Lua::new();</code><code id="71">        init(&amp;lua).unwrap();</code><code id="72"></code><code id="73">        lua.exec::&lt;_, ()&gt;(r#&quot;</code><code id="74">            local regex = regex.new([[(?P&lt;y&gt;\d{4})-(?P&lt;m&gt;\d{2})-(?P&lt;d&gt;\d{2})]])</code><code id="75">            local before = &quot;2012-03-14, 2013-01-01 and 2014-07-05&quot;</code><code id="76">            local result = regex:replace_all(before, &quot;$m&#x2F;$d&#x2F;$y&quot;)</code><code id="77"></code><code id="78">            assert(result == &quot;03&#x2F;14&#x2F;2012, 01&#x2F;01&#x2F;2013 and 07&#x2F;05&#x2F;2014&quot;)</code><code id="79">        &quot;#, None).unwrap();</code><code id="80">    }</code><code id="81"></code><code id="82">    #[test]</code><code id="83">    fn lua_regex_match () {</code><code id="84">        let lua = Lua::new();</code><code id="85">        init(&amp;lua).unwrap();</code><code id="86"></code><code id="87">        lua.exec::&lt;_, ()&gt;(r#&quot;</code><code id="88">            local regex = regex.new([[^\d{4}-\d{2}-\d{2}$]])</code><code id="89">            local date = &quot;2014-01-01&quot;</code><code id="90">            local result = regex:match(date)</code><code id="91"></code><code id="92">            assert(result == true)</code><code id="93">        &quot;#, None).unwrap();</code><code id="94">    }</code><code id="95"></code><code id="96">    #[test]</code><code id="97">    fn lua_regex_captures () {</code><code id="98">        let lua = Lua::new();</code><code id="99">        init(&amp;lua).unwrap();</code><code id="100"></code><code id="101">        lua.exec::&lt;_, ()&gt;(r#&quot;</code><code id="102">            local regex = regex.new([[&#x27;([^&#x27;]+)&#x27;\s+\((\d{4})\)]])</code><code id="103">            local val = &quot;Not my favorite movie: &#x27;Citizen Kane&#x27; (1941)&quot;</code><code id="104">            local result = regex:capture(val):to_table()</code><code id="105"></code><code id="106">            assert(result ~= nil)</code><code id="107">            assert(result[1] == &quot;&#x27;Citizen Kane&#x27; (1941)&quot;)</code><code id="108">            assert(result[2] == &quot;Citizen Kane&quot;)</code><code id="109">            assert(result[3] == &quot;1941&quot;)</code><code id="110">        &quot;#, None).unwrap();</code><code id="111">    }</code><code id="112">}</code></pre>
</body>
</html>
