<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Module List</title>
    <link rel="stylesheet" type="text/css" href="../../../css/lua.css">
</head>
<body>
	<pre><code id="1">use rlua::prelude::*;</code><code id="2">use rlua::{UserDataMethods, UserData, MetaMethod, Value, Table, Lua, FromLua};</code><code id="3">use std::collections::HashSet;</code><code id="4"></code><code id="5">#[derive(Clone)]</code><code id="6">struct StringSet (HashSet&lt;String&gt;);</code><code id="7"></code><code id="8">impl UserData for StringSet {</code><code id="9">    fn add_methods&lt;&#x27;lua, M: UserDataMethods&lt;&#x27;lua, Self&gt;&gt;(methods: &amp;mut M) {</code><code id="10"></code><code id="11">        methods.add_method_mut(&quot;insert&quot;, |_, this, elem: String| {</code><code id="12">            this.0.insert(elem);</code><code id="13">            Ok(())</code><code id="14">        });</code><code id="15"></code><code id="16">        methods.add_method_mut(&quot;remove&quot;, |_, this, elem: String| {</code><code id="17">            this.0.remove(&amp;elem);</code><code id="18">            Ok(())</code><code id="19">        });</code><code id="20"></code><code id="21">        methods.add_method(&quot;contains&quot;, |_, this, elem: String| {</code><code id="22">            Ok(this.0.contains(&amp;elem))</code><code id="23">        });</code><code id="24"></code><code id="25">        methods.add_method_mut(&quot;clear&quot;, |_, this, _: ()| {</code><code id="26">            this.0.clear();</code><code id="27">            Ok(())</code><code id="28">        });</code><code id="29"></code><code id="30">        methods.add_method(&quot;is_empty&quot;, |_, this, _: ()| {</code><code id="31">            Ok(this.0.is_empty())</code><code id="32">        });</code><code id="33"></code><code id="34">        methods.add_method(&quot;difference&quot;, |_, this, other: StringSet| {</code><code id="35">            let result: HashSet&lt;String&gt; = this.0.difference(&amp;other.0).cloned().collect();</code><code id="36">            Ok(StringSet(result))</code><code id="37">        });</code><code id="38"></code><code id="39">        methods.add_method(&quot;symmetric&quot;, |_, this, other: StringSet| {</code><code id="40">            let result: HashSet&lt;String&gt; = this.0.symmetric_difference(&amp;other.0).cloned().collect();</code><code id="41">            Ok(StringSet(result))</code><code id="42">        });</code><code id="43"></code><code id="44">        methods.add_method(&quot;intersection&quot;, |_, this, other: StringSet| {</code><code id="45">            let result: HashSet&lt;String&gt; = this.0.intersection(&amp;other.0).cloned().collect();</code><code id="46">            Ok(StringSet(result))</code><code id="47">        });</code><code id="48"></code><code id="49">        methods.add_method(&quot;union&quot;, |_, this, other: StringSet| {</code><code id="50">            let result: HashSet&lt;String&gt; = this.0.union(&amp;other.0).cloned().collect();</code><code id="51">            Ok(StringSet(result))</code><code id="52">        });</code><code id="53"></code><code id="54">        methods.add_method(&quot;is_disjoint&quot;, |_, this, other: StringSet| {</code><code id="55">            Ok(this.0.is_disjoint(&amp;other.0))</code><code id="56">        });</code><code id="57"></code><code id="58">        methods.add_method(&quot;is_subset&quot;, |_, this, other: StringSet| {</code><code id="59">            Ok(this.0.is_subset(&amp;other.0))</code><code id="60">        });</code><code id="61"></code><code id="62">        methods.add_method(&quot;is_superset&quot;, |_, this, other: StringSet| {</code><code id="63">            Ok(this.0.is_superset(&amp;other.0))</code><code id="64">        });</code><code id="65"></code><code id="66">        methods.add_meta_method(MetaMethod::ToString, |_, this, _: ()| {</code><code id="67">            Ok(format!(&quot;{:?}&quot;, this.0))</code><code id="68">        });</code><code id="69"></code><code id="70">        methods.add_meta_method(MetaMethod::Len, |_, this, _: ()| {</code><code id="71">            Ok(this.0.len())</code><code id="72">        });</code><code id="73"></code><code id="74">        methods.add_method(&quot;clone&quot;, |_, this, _: ()| {</code><code id="75">            Ok(StringSet(this.0.clone()))</code><code id="76">        });</code><code id="77"></code><code id="78">        methods.add_method(&quot;to_table&quot;, |lua, this, _: ()| {</code><code id="79">            let table = lua.create_sequence_from(this.0.iter().cloned())?;</code><code id="80">            Ok(table)</code><code id="81">        });</code><code id="82">    }</code><code id="83">}</code><code id="84"></code><code id="85">pub fn init(lua: &amp;Lua) -&gt; Result&lt;(), LuaError&gt; {</code><code id="86"></code><code id="87">    type Set = HashSet&lt;String&gt;;</code><code id="88"></code><code id="89">    fn from_table (table: Table) -&gt; Result&lt;Set, LuaError&gt; {</code><code id="90">        let mut set = HashSet::new();</code><code id="91">        for elem in table.sequence_values() {</code><code id="92">            set.insert(elem?);</code><code id="93">        }</code><code id="94">        Ok(set)</code><code id="95">    }</code><code id="96"></code><code id="97">    fn get_sets (lua: &amp;Lua, args: (Value, Value)) -&gt; Result&lt;(Set, Set), LuaError&gt; {</code><code id="98">        fn from_value (a: Value, lua: &amp;Lua) -&gt; Result&lt;Set, LuaError&gt; {</code><code id="99">            Ok(match a {</code><code id="100">                Value::Table(t) =&gt; from_table(t)?,</code><code id="101">                a@_ =&gt; StringSet::from_lua(a, lua)?.0</code><code id="102">            })</code><code id="103">        }</code><code id="104">        let (a, b) = args;</code><code id="105">        Ok((from_value(a, lua)?, from_value(b, lua)?))</code><code id="106">    }</code><code id="107"></code><code id="108">    let module = lua.create_table()?;</code><code id="109"></code><code id="110">    module.set(&quot;create&quot;, lua.create_function(</code><code id="111">        |_, _: ()|  Ok(StringSet(HashSet::new()))</code><code id="112">    )? )?;</code><code id="113"></code><code id="114">    module.set(&quot;from_table&quot;, lua.create_function(</code><code id="115">        |_, t: Table|  Ok(StringSet(from_table(t)?))</code><code id="116">    )? )?;</code><code id="117"></code><code id="118">    let g = lua.globals();</code><code id="119">    g.set(&quot;stringset&quot;, module)?;</code><code id="120"></code><code id="121">    g.set(&quot;difference&quot;, lua.create_function( |lua, args: (Value, Value)| {</code><code id="122">        let (a, b) = get_sets(lua, args)?;</code><code id="123">        let c = a.difference(&amp;b).cloned().collect();</code><code id="124">        Ok(StringSet(c))</code><code id="125">    })? )?;</code><code id="126"></code><code id="127">    g.set(&quot;symmetric&quot;, lua.create_function( |lua, args: (Value, Value)| {</code><code id="128">        let (a, b) = get_sets(lua, args)?;</code><code id="129">        let c = a.symmetric_difference(&amp;b).cloned().collect();</code><code id="130">        Ok(StringSet(c))</code><code id="131">    })? )?;</code><code id="132"></code><code id="133">    g.set(&quot;intersection&quot;, lua.create_function( |lua, args: (Value, Value)| {</code><code id="134">        let (a, b) = get_sets(lua, args)?;</code><code id="135">        let c = a.intersection(&amp;b).cloned().collect();</code><code id="136">        Ok(StringSet(c))</code><code id="137">    })? )?;</code><code id="138"></code><code id="139">    g.set(&quot;union&quot;, lua.create_function( |lua, args: (Value, Value)| {</code><code id="140">        let (a, b) = get_sets(lua, args)?;</code><code id="141">        let c = a.union(&amp;b).cloned().collect();</code><code id="142">        Ok(StringSet(c))</code><code id="143">    })? )?;</code><code id="144"></code><code id="145">    Ok(())</code><code id="146">}</code><code id="147"></code><code id="148">#[cfg(test)]</code><code id="149">mod tests {</code><code id="150">    use super::*;</code><code id="151"></code><code id="152">    #[test]</code><code id="153">    fn direct_methods() {</code><code id="154">        let lua = Lua::new();</code><code id="155">        init(&amp;lua).unwrap();</code><code id="156">        lua.exec::&lt;_, Value&gt;(r#&quot;</code><code id="157">            local a = stringset.create()</code><code id="158">            a:insert(&quot;Colombia&quot;)</code><code id="159">            a:insert(&quot;Canada&quot;)</code><code id="160">            a:insert(&quot;China&quot;)</code><code id="161"></code><code id="162">            local b = stringset.create()</code><code id="163">            b:insert(&quot;Venezuela&quot;)</code><code id="164">            b:insert(&quot;Colombia&quot;)</code><code id="165">            b:insert(&quot;Brazil&quot;)</code><code id="166"></code><code id="167">            local c = a:union(b)</code><code id="168">            assert(#c == 5)</code><code id="169">            assert(c:contains(&quot;Colombia&quot;))</code><code id="170">            assert(c:contains(&quot;Venezuela&quot;))</code><code id="171">            assert(c:contains(&quot;Canada&quot;))</code><code id="172"></code><code id="173">            c = a:intersection(b)</code><code id="174">            assert(#c == 1)</code><code id="175">            assert(c:contains(&quot;Colombia&quot;))</code><code id="176">            assert(not c:contains(&quot;Canada&quot;))</code><code id="177"></code><code id="178">            c = a:difference(b)</code><code id="179">            assert(#c == 2)</code><code id="180">            assert(c:contains(&quot;Canada&quot;))</code><code id="181">            assert(not c:contains(&quot;Colombia&quot;))</code><code id="182"></code><code id="183">            c = a:symmetric(b)</code><code id="184">            assert(#c == 4)</code><code id="185">            assert(c:contains(&quot;Canada&quot;))</code><code id="186">            assert(c:contains(&quot;Venezuela&quot;))</code><code id="187">            assert(not c:contains(&quot;Colombia&quot;))</code><code id="188"></code><code id="189">            d = a:clone()</code><code id="190">            d:remove(&quot;Canada&quot;)</code><code id="191">            assert(a:is_superset(d))</code><code id="192">            assert(d:is_subset(a))</code><code id="193">            assert(not a:is_disjoint(b))</code><code id="194">            assert(a:is_disjoint(b:difference(a)))</code><code id="195"></code><code id="196">            d:clear()</code><code id="197">            assert(d:is_empty())</code><code id="198"></code><code id="199">            local t = a:union(b):to_table()</code><code id="200">            for i, v in ipairs(t) do</code><code id="201">                print(i, v)</code><code id="202">            end</code><code id="203">        &quot;#, None).unwrap();</code><code id="204">    }</code><code id="205"></code><code id="206">    #[test]</code><code id="207">    fn shortcut_syntax() {</code><code id="208">        let lua = Lua::new();</code><code id="209">        init(&amp;lua).unwrap();</code><code id="210">        lua.exec::&lt;_, Value&gt;(r#&quot;</code><code id="211">            local a = stringset.create()</code><code id="212">            a:insert(&quot;Canada&quot;)</code><code id="213">            a:insert(&quot;China&quot;)</code><code id="214">            a:insert(&quot;Colombia&quot;)</code><code id="215"></code><code id="216">            local b = {&quot;Colombia&quot;, &quot;Brazil&quot;, &quot;Venezuela&quot;}</code><code id="217">            local c = intersection(a, b)</code><code id="218">            assert(c:contains(&quot;Colombia&quot;))</code><code id="219">            assert(not c:contains(&quot;Canada&quot;))</code><code id="220"></code><code id="221">            union(a, b)</code><code id="222">            difference(a, b)</code><code id="223">            symmetric(a, b)</code><code id="224">        &quot;#, None).unwrap();</code><code id="225">    }</code><code id="226">}</code><code id="227"></code></pre>
</body>
</html>
