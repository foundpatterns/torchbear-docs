<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Module List</title>
    <link rel="stylesheet" type="text/css" href="../../../css/lua.css">
</head>
<body>
	<pre><code id="1">use rlua::prelude::*;</code><code id="2">use std::fs;</code><code id="3">use std::io::Read;</code><code id="4">use std::result;</code><code id="5">use std::path::Path;</code><code id="6">use tar::Archive;</code><code id="7">use error::Error;</code><code id="8"></code><code id="9">use super::ByteBuf;</code><code id="10"></code><code id="11">fn extract&lt;T: Read&gt;(archive: &amp;mut Archive&lt;T&gt;, dst: &amp;Path) -&gt; result::Result&lt;(), LuaError&gt; {</code><code id="12">    for file in archive.entries().map_err(LuaError::external)? {</code><code id="13">        file</code><code id="14">            .and_then(|mut file| file.unpack_in(&amp;dst))</code><code id="15">            .map_err(LuaError::external)?;</code><code id="16">    }</code><code id="17">    Ok(())</code><code id="18">}</code><code id="19"></code><code id="20">pub fn init(lua: &amp;Lua) -&gt; ::Result&lt;()&gt; {</code><code id="21">    let module = lua.create_table()?;</code><code id="22">    module.set(&quot;decompress&quot;, lua.create_function(|_, (src, dst): (String, String)| {</code><code id="23">        let tar = fs::File::open(src).map_err(LuaError::external)?;</code><code id="24">        let dst = Path::new(&amp;dst);</code><code id="25">        let mut archive = Archive::new(tar);</code><code id="26">        extract(&amp;mut archive, &amp;dst)</code><code id="27">    })?)?;</code><code id="28"></code><code id="29">    module.set(&quot;decompress_buf&quot;, lua.create_function(|_, (data, dst): (ByteBuf, String)| {</code><code id="30">        let dst = Path::new(&amp;dst);</code><code id="31">        let mut archive = Archive::new(&amp;data.0[..]);</code><code id="32">        extract(&amp;mut archive, &amp;dst)</code><code id="33">    })?)?;</code><code id="34"></code><code id="35">    lua.globals().set(&quot;tar&quot;, module).map_err(Error::from)?;</code><code id="36"></code><code id="37">    Ok(())</code><code id="38">}</code><code id="39"></code></pre>
</body>
</html>
