<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Module List</title>
    <link rel="stylesheet" type="text/css" href="../../../css/lua.css">
</head>
<body>
	<pre><code id="1">use rlua::prelude::*;</code><code id="2">use std::{</code><code id="3">    fs,</code><code id="4">    io::Read,</code><code id="5">    result,</code><code id="6">    path::Path</code><code id="7">};</code><code id="8">use tar::Archive;</code><code id="9">use crate::error::Error;</code><code id="10"></code><code id="11">use super::ByteBuf;</code><code id="12"></code><code id="13">fn extract&lt;T: Read&gt;(archive: &amp;mut Archive&lt;T&gt;, dst: &amp;Path) -&gt; result::Result&lt;(), LuaError&gt; {</code><code id="14">    for file in archive.entries().map_err(LuaError::external)? {</code><code id="15">        file</code><code id="16">            .and_then(|mut file| file.unpack_in(&amp;dst))</code><code id="17">            .map_err(LuaError::external)?;</code><code id="18">    }</code><code id="19">    Ok(())</code><code id="20">}</code><code id="21"></code><code id="22">pub fn init(lua: &amp;Lua) -&gt; crate::Result&lt;()&gt; {</code><code id="23">    let module = lua.create_table()?;</code><code id="24">    module.set(&quot;decompress&quot;, lua.create_function(|_, (src, dst): (String, String)| {</code><code id="25">        let tar = fs::File::open(src).map_err(LuaError::external)?;</code><code id="26">        let dst = Path::new(&amp;dst);</code><code id="27">        let mut archive = Archive::new(tar);</code><code id="28">        extract(&amp;mut archive, &amp;dst)</code><code id="29">    })?)?;</code><code id="30"></code><code id="31">    module.set(&quot;decompress_buf&quot;, lua.create_function(|_, (data, dst): (ByteBuf, String)| {</code><code id="32">        let dst = Path::new(&amp;dst);</code><code id="33">        let mut archive = Archive::new(&amp;data.0[..]);</code><code id="34">        extract(&amp;mut archive, &amp;dst)</code><code id="35">    })?)?;</code><code id="36"></code><code id="37">    lua.globals().set(&quot;tar&quot;, module).map_err(Error::from)?;</code><code id="38"></code><code id="39">    Ok(())</code><code id="40">}</code><code id="41"></code></pre>
</body>
</html>
