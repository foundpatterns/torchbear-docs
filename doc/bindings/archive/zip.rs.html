<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Module List</title>
    <link rel="stylesheet" type="text/css" href="../../../css/lua.css">
</head>
<body>
	<pre><code id="1">use rlua::prelude::*;</code><code id="2">use zip::ZipArchive;</code><code id="3">use std::fs;</code><code id="4">use std::io;</code><code id="5">use std::path::Path;</code><code id="6"></code><code id="7">pub fn init(lua: &amp;Lua) -&gt; crate::Result&lt;()&gt; {</code><code id="8"></code><code id="9">    let module = lua.create_table()?;</code><code id="10">    module.set(&quot;decompress&quot;, lua.create_function(|_, (src, dst): (String, String)| {</code><code id="11">        let zip = fs::File::open(src).map_err(LuaError::external)?;</code><code id="12"></code><code id="13">        ZipArchive::new(zip).map_err(LuaError::external).and_then(|mut archive|{</code><code id="14">            let path = Path::new(&amp;dst);</code><code id="15">            for i in 0..archive.len() {</code><code id="16">                let mut temp = archive.by_index(i).map_err(LuaError::external)?;</code><code id="17">                let outpath = temp.sanitized_name();</code><code id="18">                if (&amp;*temp.name()).ends_with(&#x27;&#x2F;&#x27;) {</code><code id="19">                    fs::create_dir_all(path.join(&amp;outpath)).map_err(LuaError::external)?;</code><code id="20">                } else {</code><code id="21">                    if let Some(p) = outpath.parent() {</code><code id="22">                        if !p.exists() {</code><code id="23">                            fs::create_dir_all(path.join(p)).map_err(LuaError::external)?;</code><code id="24">                        }</code><code id="25">                    }</code><code id="26">                    let p = path.join(&amp;outpath);</code><code id="27">                    fs::File::create(p)</code><code id="28">                        .and_then(|mut output| io::copy(&amp;mut temp, &amp;mut output) ).map_err(LuaError::external)?;</code><code id="29">                }</code><code id="30"></code><code id="31">            }</code><code id="32"></code><code id="33">            Ok(())</code><code id="34">        })</code><code id="35"></code><code id="36">    })?)?;</code><code id="37"></code><code id="38">    lua.globals().set(&quot;zip&quot;, module)?;</code><code id="39"></code><code id="40">    Ok(())</code><code id="41">}</code></pre>
</body>
</html>
